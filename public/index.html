<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EmotiKnow Emma - Mouth Sync</title>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; }
    #container { position:relative; display:inline-block; }
    #avatar { width:400px; }
    #mouth {
      position:absolute;
      top:0; left:0;
      transform-origin:center center;
      pointer-events:none;
    }
  </style>
</head>
<body>
  <h2>EmotiKnow — Mouth Sync Preview</h2>

  <textarea id="text" rows="3" cols="50">
Hi, I’m Emma. I can talk and move my mouth in sync. How can I help?
  </textarea><br>
  <button id="speak">Speak</button>
  <span>Viseme: <span id="viseme">X</span></span>

  <div>
    <label>Mouth X: <input type="range" id="mouthX" min="0" max="400" value="165"></label>
    <label>Mouth Y: <input type="range" id="mouthY" min="0" max="400" value="98"></label>
    <label>Scale: <input type="range" id="mouthScale" min="0.1" max="2" step="0.05" value="0.5"></label>
    <label>Rotate: <input type="range" id="mouthRotate" min="-30" max="30" step="1" value="-1"></label>
  </div>

  <div id="container">
    <img id="avatar" src="emma.jpg">
    <img id="mouth" src="/mouth/X.png">
  </div>

  <script>
    // === Config ===
    const VISEMES = ["X","A","E","I","O","U","M","F","L","S"];
    let playing = false;

    const txt = document.getElementById("text");
    const speakBtn = document.getElementById("speak");
    const visemeEl = document.getElementById("viseme");
    const avatar = document.getElementById("avatar");
    const mouthImg = document.getElementById("mouth");

    // === Controls ===
    const mouthX = document.getElementById("mouthX");
    const mouthY = document.getElementById("mouthY");
    const mouthScale = document.getElementById("mouthScale");
    const mouthRotate = document.getElementById("mouthRotate");

    function updateMouthTransform() {
      mouthImg.style.left = mouthX.value + "px";
      mouthImg.style.top = mouthY.value + "px";
      mouthImg.style.transform = `scale(${mouthScale.value}) rotate(${mouthRotate.value}deg)`;
    }
    [mouthX, mouthY, mouthScale, mouthRotate].forEach(ctrl =>
      ctrl.addEventListener("input", updateMouthTransform)
    );
    updateMouthTransform();

    // === Viseme function ===
    function setViseme(v) {
      visemeEl.textContent = v;
      mouthImg.src = `/mouth/${v}.png`;
    }

    function fakeTimeline(text) {
      const seq = ["M","A","E","I","O","U","S","L","F","X"];
      const groups = Math.max(8, Math.ceil(text.length / 4));
      return Array.from({length: groups}, (_,i) => ({
        t: i*120,
        v: seq[i % seq.length]
      }));
    }

    function animate(marks) {
      let i = 0;
      function step() {
        if (!playing) return;
        const v = marks[i] ? marks[i].v : "X";
        setViseme(v);
        i++;
        if (i < marks.length) {
          setTimeout(step, 120);
        } else {
          setViseme("X");
          playing = false;
        }
      }
      step();
    }

    // === Speak handler ===
    speakBtn.onclick = () => {
      if (playing) return;
      playing = true;

      const u = new SpeechSynthesisUtterance(txt.value);
      u.rate = 1;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);

      const marks = fakeTimeline(txt.value);
      animate(marks);

      u.onend = () => { playing = false; setViseme("X"); };
    };
  </script>
</body>
</html>
