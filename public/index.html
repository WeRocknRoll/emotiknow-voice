<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EmotiKnow ‚Äî Emma (D-ID + OpenAI)</title>
  <style>
    :root {
      --bg:#0b0f14; --panel:#121821; --muted:#9fb0c3; --text:#e7edf5; --brand:#4ea3ff;
      --btn:#2a3a52; --btn2:#204a34;
    }
    * { box-sizing:border-box; }
    body {
      margin:0; padding:24px; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    }
    h1 { margin:0 0 16px 0; font-weight:800; letter-spacing:.2px; }
    .grid {
      display:grid; gap:22px;
      grid-template-columns: minmax(280px, 560px) minmax(480px, 1fr);
      align-items:start;
    }
    .card { background:var(--panel); border-radius:16px; padding:16px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    textarea {
      width:100%; height:120px; resize:vertical; padding:12px 14px;
      background:#0f141b; color:var(--text); border:1px solid #223142; border-radius:12px;
      font-size:16px; line-height:1.4;
    }
    button {
      appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:700;
      background:var(--btn); color:var(--text); cursor:pointer;
    }
    button.primary { background:var(--brand); color:#06101b; }
    button.stop { background:#5b2030; }
    .muted { color:var(--muted); font-size:13px; }
    video, .video-frame {
      width:100%; aspect-ratio:16/9; background:#000; border-radius:14px; overflow:hidden;
      display:block;
    }
    #log {
      background:#0a0f14; color:#bcd0e4; border-radius:12px; padding:12px; white-space:pre-wrap;
      max-height:240px; overflow:auto; font-size:12px;
    }
    .pill { background:#17212c; color:var(--muted); padding:8px 10px; border-radius:999px; font-size:12px;}
  </style>
</head>
<body>
  <h1>EmotiKnow ‚Äî Emma (D-ID + OpenAI)</h1>

  <div class="grid">
    <!-- Left: user input -->
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">Say or type something to Emma</div>
      <textarea id="prompt" placeholder="Ask Emma anything‚Ä¶">hello</textarea>
      <div class="row" style="margin-top:10px;">
        <button id="askBtn" class="primary">Ask Emma</button>
        <button id="micBtn">üéôÔ∏è Dictate</button>
        <button id="stopBtn" class="stop">‚ñ† Stop</button>
        <span id="status" class="pill">Ready.</span>
      </div>
    </div>

    <!-- Right: Emma video -->
    <div class="card">
      <video id="emmaVideo" class="video-frame" playsinline controls></video>
      <div class="muted" style="margin-top:6px;">
        If the video freezes, just click Ask again; a fresh talk will be generated.
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:22px;">
    <div class="muted" style="margin-bottom:8px;">Log</div>
    <pre id="log"></pre>
  </div>

  <!-- üëâ Set your D-ID Agent here (easy to change per deployment) -->
  <script>
    // If you prefer, you can paste the full share URL and extract the id:
    // const shareUrl = "https://studio.d-id.com/agents/share?id=v2_agt_E_3zw1Jf&...";
    // window.EMMA_AGENT_ID = new URL(shareUrl).searchParams.get("id");
    window.EMMA_AGENT_ID = "v2_agt_E_3zw1Jf";
  </script>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const promptEl = document.getElementById('prompt');
    const askBtn = document.getElementById('askBtn');
    const micBtn = document.getElementById('micBtn');
    const stopBtn = document.getElementById('stopBtn');
    const videoEl = document.getElementById('emmaVideo');

    function log(line){ logEl.textContent += (logEl.textContent ? "\n" : "") + line; logEl.scrollTop = logEl.scrollHeight; }
    function setStatus(t){ statusEl.textContent = t; }

    // --- Browser speech-to-text (Web Speech API). Fallback is manual typing.
    let recognizer = null;
    micBtn.addEventListener('click', () => {
      try{
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR){ alert("Speech recognition not supported in this browser."); return; }
        recognizer?.abort?.();
        recognizer = new SR();
        recognizer.lang = "en-US";
        recognizer.interimResults = true;
        recognizer.onresult = (e)=>{
          let final = "";
          for(let i=0;i<e.results.length;i++){
            final += e.results[i][0].transcript;
          }
          promptEl.value = final;
        };
        recognizer.onstart = ()=> setStatus("Listening‚Ä¶");
        recognizer.onend = ()=> setStatus("Ready.");
        recognizer.start();
      }catch(err){
        log("[mic] " + err.message);
      }
    });
    stopBtn.addEventListener('click', ()=> recognizer?.abort?.());

    // --- Ask flow: 1) OpenAI answer  2) D-ID talk (video)
    askBtn.addEventListener('click', async ()=>{
      const user = promptEl.value.trim();
      if(!user){ return; }
      setStatus("Thinking‚Ä¶");
      log("You: " + user);

      // 1) Ask OpenAI on the server (keeps key safe)
      let replyText = "";
      try{
        const r = await fetch("/api/openai-chat", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ prompt: user })
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.error || ("HTTP " + r.status));
        replyText = (j.text || "").trim();
      }catch(err){
        setStatus("Error");
        log("[openai] " + err.message);
        return;
      }
      log("Emma (text): " + replyText);

      // 2) Ask D-ID to speak that reply using your Agent
      try{
        setStatus("Speaking‚Ä¶");
        const r2 = await fetch("/api/did-talk", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({
            agentId: window.EMMA_AGENT_ID,
            text: replyText
          })
        });
        const j2 = await r2.json();
        if(!r2.ok) throw new Error(j2.error || ("HTTP " + r2.status));

        // We expect a playable URL back (streaming or mp4)
        const url = j2.videoUrl || j2.streamUrl || j2.result_url || j2.url;
        if(!url) throw new Error("No video url in response.");

        videoEl.src = url;
        await videoEl.play();
        setStatus("Ready.");
      }catch(err){
        setStatus("Error");
        log("[d-id] " + err.message);
      }
    });
  </script>
</body>
</html>
