<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EmotiKnow ‚Äî Emma (D-ID + OpenAI)</title>
  <style>
    :root{
      --bg:#0d1116; --panel:#131a22; --ink:#e8eef6; --muted:#9fb0c3;
      --brand:#6aa7ff; --accent:#7bd9b5; --danger:#ff7a7a; --line:#213042;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Arial;
    }
    .wrap{
      max-width:1280px; margin:28px auto; padding:0 16px; display:grid; gap:22px;
    }
    h1{margin:0 0 6px 0; font-size:clamp(22px,2.8vw,36px); letter-spacing:.2px}
    .grid{display:grid; grid-template-columns: 1.1fr 1.1fr; gap:22px}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr;}}
    .card{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:16px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    textarea{
      width:100%; min-height:120px; resize:vertical; border-radius:10px; padding:12px;
      background:#0b1016; border:1px solid var(--line); color:var(--ink); font-size:16px;
    }
    button{
      appearance:none; border:0; border-radius:10px; padding:10px 16px; font-weight:600; cursor:pointer;
      background:var(--brand); color:#091018;
    }
    button.secondary{ background:#1b2531; color:var(--ink); }
    button.danger{ background:var(--danger); color:#091018; }
    button:disabled{opacity:.6; cursor:not-allowed}
    .hint{font-size:13px; color:var(--muted)}
    .log{font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap;
      background:#0a0f14; border:1px solid var(--line); border-radius:10px; padding:12px; min-height:64px}
    video{
      width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; border:1px solid var(--line);
    }
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; background:#0e1620; border:1px solid var(--line); color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>EmotiKnow ‚Äî Emma (D-ID + OpenAI)</h1>

    <div class="grid">
      <!-- Left: input + controls -->
      <div class="card">
        <div class="hint">Say or type something to Emma</div>
        <textarea id="userInput" placeholder="Ask me anything‚Ä¶"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="askBtn">Ask Emma</button>
          <button id="dictateBtn" class="secondary">üéôÔ∏è Dictate</button>
          <button id="stopBtn" class="danger">‚ñ† Stop</button>
          <span id="state" class="hint">Ready.</span>
        </div>
        <div style="margin-top:10px" class="hint">
          Agent: <span class="badge" id="agentBadge">v2_agt_E_3zw1Jf</span>
          &nbsp;‚Ä¢&nbsp; If the video freezes, just click <b>Ask</b> again to generate a fresh reply.
        </div>
      </div>

      <!-- Right: video -->
      <div class="card">
        <video id="emmaVideo" controls playsinline></video>
      </div>
    </div>

    <!-- Log -->
    <div class="card">
      <div class="hint" style="margin-bottom:8px">Log</div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    // Your D-ID Agent ID (can also pass ?agent=... in the URL to override)
    const DEFAULT_AGENT_ID = 'v2_agt_E_3zw1Jf';
    const urlAgent = new URLSearchParams(location.search).get('agent') || DEFAULT_AGENT_ID;

    const els = {
      input: document.getElementById('userInput'),
      ask: document.getElementById('askBtn'),
      dictate: document.getElementById('dictateBtn'),
      stop: document.getElementById('stopBtn'),
      video: document.getElementById('emmaVideo'),
      log: document.getElementById('log'),
      state: document.getElementById('state'),
      agentBadge: document.getElementById('agentBadge')
    };
    els.agentBadge.textContent = urlAgent;

    function log(line){
      els.log.textContent += (els.log.textContent ? '\n' : '') + line;
      els.log.scrollTop = els.log.scrollHeight;
    }
    function setState(text){ els.state.textContent = text; }

    // ---- Dictation (Web Speech API: Chrome / Edge) ----
    let recog = null;
    if ('webkitSpeechRecognition' in window){
      const SR = window.webkitSpeechRecognition;
      recog = new SR();
      recog.continuous = false;
      recog.interimResults = false;
      recog.lang = 'en-US';
      recog.onresult = (e)=>{
        const t = e.results?.[0]?.[0]?.transcript || '';
        if (t) {
          els.input.value = t;
          log('üéôÔ∏è ' + t);
        }
      };
      recog.onerror = err => log('[mic] ' + err.error);
      recog.onend = ()=> setState('Ready.');
    } else {
      els.dictate.disabled = true;
      els.dictate.title = 'Speech recognition not supported in this browser';
    }

    els.dictate.addEventListener('click', ()=>{
      if (!recog) return;
      setState('Listening‚Ä¶');
      recog.start();
    });

    els.stop.addEventListener('click', ()=>{
      els.video.pause();
      els.video.currentTime = 0;
      setState('Stopped.');
    });

    els.ask.addEventListener('click', askEmma);

    async function askEmma(){
      try{
        const raw = (els.input.value || '').trim();
        if (!raw) { els.input.focus(); return; }
        setState('Thinking‚Ä¶');

        // 1) Ask OpenAI for Emma‚Äôs textual reply
        const r1 = await fetch('/api/openai-talk', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ prompt: raw })
        });
        const j1 = await r1.json();
        if (!r1.ok) throw new Error(j1?.error || 'openai-talk failed');

        const reply = (j1.reply || '').trim() || 'Hi!';
        log(`You: ${raw}`);
        log(`Emma (text): ${reply}`);

        setState('Generating video‚Ä¶');

        // 2) Ask D-ID to generate a talking video from the reply
        const r2 = await fetch('/api/did-talk', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ agentId: urlAgent, text: reply })
        });
        const j2 = await r2.json();
        if (!r2.ok) throw new Error(j2?.error || 'did-talk failed');

        const videoUrl = j2.url || j2?.raw?.result_url || j2?.raw?.output_url || j2?.raw?.stream_url;
        if (!videoUrl){
          log('[d-id] No video URL in response'); setState('Ready.'); return;
        }

        // 3) Play the video
        els.video.src = videoUrl;
        await els.video.play().catch(()=>{ /* user gesture may be required */ });
        setState('Playing.');
      }catch(err){
        console.error(err);
        log(`[error] ${err.message || err}`);
        setState('Error');
      }
    }

    // Nice default
    els.input.value = 'Give me a one-sentence, kind, upbeat greeting to start our day.';
  </script>
</body>
</html>
