<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EmotiKnow — Emma (Voice Companion)</title>

  <style>
    :root{
      --bg:#0c0f12; --panel:#12161b; --text:#e7edf5; --muted:#9fb0c3; --brand:#4ea3ff;
      --accent:#7bd9b5; --danger:#ff7a7a;
    }
    body{
      margin:0; font-family: system-ui, sans-serif;
      background:var(--bg); color:var(--text); display:flex; gap:22px; padding:20px;
    }
    .stage{ flex:1; display:grid; place-items:center; }
    .canvas{
      position:relative; width:min(1100px,95vw); aspect-ratio:16/9;
      background:#000; border-radius:12px; overflow:hidden;
    }
    .emma-bg{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
    }
    #mouth{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:200px; user-select:none; pointer-events:none;
    }
    .anchor-dot{
      position:absolute; width:10px; height:10px; border-radius:50%;
      background:var(--accent); transform:translate(-50%,-50%);
      pointer-events:none; opacity:.8;
    }
    .panel{
      width:380px; background:var(--panel); border-radius:14px; padding:18px;
      display:flex; flex-direction:column; gap:18px;
    }
    h1{font-size:20px; margin:0 0 6px 0}
    button{padding:10px 16px; border-radius:10px; font-weight:600; cursor:pointer;}
    button#startBtn{ background:var(--brand); color:#081018; border:0; }
    button#hangBtn{ background:#1b2430; color:var(--text); border:0; }
    input[type="range"]{ width:100% }
    select{width:100%; padding:8px; border-radius:10px; background:#0d131a; color:var(--text);}
    pre{background:#0a0f14; padding:10px; border-radius:8px; font-size:12px; color:#bcd0e4; max-height:200px; overflow:auto;}
  </style>
</head>
<body>
  <div class="stage">
    <div class="canvas" id="canvas">
      <img id="bg" class="emma-bg" src="/emma.jpg" alt="Emma" />
      <img id="mouth" src="/mouth/mouth_closed.png" alt="mouth overlay" />
      <div id="anchorDot" class="anchor-dot" style="display:none;"></div>
    </div>
  </div>

  <aside class="panel">
    <h1>EmotiKnow — Emma (Voice Companion)</h1>

    <div class="row">
      <button id="startBtn">Start</button>
      <button id="hangBtn" disabled>Hang Up</button>
    </div>

    <label><input type="checkbox" id="connectVoice" checked /> Connect voice (uses /api/realtime-session)</label>

    <div class="ctrl">
      <label>Target width (mouth) <span id="wLabel">140 px</span></label>
      <input type="range" id="mouthWidth" min="80" max="280" step="2" value="140" />
    </div>

    <div class="ctrl">
      <label>Smooth (higher = slower)</label>
      <input type="range" id="smooth" min="0.50" max="0.95" step="0.01" value="0.80" />
    </div>

    <div class="ctrl">
      <label>Gate (ignore background)</label>
      <input type="range" id="gate" min="0.00" max="0.40" step="0.01" value="0.15" />
    </div>

    <div class="ctrl">
      <label>Mouth size (scale)</label>
      <input type="range" id="mouthScale" min="0.5" max="1.6" step="0.01" value="1.0" />
    </div>

    <details>
      <summary>Advanced (optional)</summary>
      <pre id="log">[app] ready.</pre>
    </details>
  </aside>

  <script>
    // ---------------- MOUTH FRAMES ----------------
    const MOUTH_FRAMES = {
      closed: '/mouth/mouth_closed.png',
      half:   '/mouth/mouth_half.png',
      open:   '/mouth/mouth_open.png',
    };

    function pickMouthByLevel(level){
      if (level > 0.30) return MOUTH_FRAMES.open;
      if (level > 0.15) return MOUTH_FRAMES.half;
      return MOUTH_FRAMES.closed;
    }

    const mouthEl = document.getElementById('mouth');
    const canvas  = document.getElementById('canvas');
    const anchorDot = document.getElementById('anchorDot');

    const wSlider = document.getElementById('mouthWidth');
    const wLabel  = document.getElementById('wLabel');
    const sSlider = document.getElementById('smooth');
    const gSlider = document.getElementById('gate');
    const scaleSlider = document.getElementById('mouthScale');

    const startBtn = document.getElementById('startBtn');
    const hangBtn  = document.getElementById('hangBtn');
    const logEl    = document.getElementById('log');
    const connectVoice = document.getElementById('connectVoice');

    function log(line){
      logEl.textContent += "\n" + line;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // ---------------- Anchor ----------------
    let anchor = JSON.parse(localStorage.getItem('emma.anchor') || 'null');
    function saveAnchor(){ localStorage.setItem('emma.anchor', JSON.stringify(anchor)); }

    function applyMouthLayout(){
      if(!anchor) return;
      mouthEl.style.left = `${anchor.x*100}%`;
      mouthEl.style.top  = `${anchor.y*100}%`;
      const pxWidth = parseInt(wSlider.value,10);
      const scale   = parseFloat(scaleSlider.value);
      mouthEl.style.width = (pxWidth * scale) + 'px';
      anchorDot.style.display = 'block';
      anchorDot.style.left = mouthEl.style.left;
      anchorDot.style.top  = mouthEl.style.top;
    }

    canvas.addEventListener('click',(e)=>{
      const rect = canvas.getBoundingClientRect();
      anchor = { x:(e.clientX-rect.left)/rect.width, y:(e.clientY-rect.top)/rect.height };
      saveAnchor(); applyMouthLayout();
      log(`[anchor] saved x=${anchor.x.toFixed(3)}, y=${anchor.y.toFixed(3)}`);
    });

    wSlider.addEventListener('input',()=>{ wLabel.textContent = `${wSlider.value} px`; applyMouthLayout(); });
    scaleSlider.addEventListener('input', applyMouthLayout);

    // ---------------- Audio meter ----------------
    let ctx, analyser, micStream, rafId, levelSmooth=0;
    function startMeter(stream){
      ctx = new (window.AudioContext||window.webkitAudioContext)();
      analyser = ctx.createAnalyser();
      const src = ctx.createMediaStreamSource(stream);
      src.connect(analyser);
      analyser.fftSize = 2048;
      const buf = new Uint8Array(analyser.fftSize);

      function tick(){
        analyser.getByteTimeDomainData(buf);
        let peak = 0;
        for(let i=0;i<buf.length;i++){
          const v = Math.abs(buf[i]-128)/128;
          if(v>peak) peak=v;
        }
        const smooth = parseFloat(sSlider.value);
        levelSmooth = levelSmooth * smooth + (1-smooth) * peak;
        const gate = parseFloat(gSlider.value);
        const activeLevel = Math.max(0, levelSmooth - gate) / (1-gate+1e-6);
        const srcPath = pickMouthByLevel(activeLevel);
        if(mouthEl.dataset.src!==srcPath){ mouthEl.dataset.src=srcPath; mouthEl.src=srcPath; }
        rafId = requestAnimationFrame(tick);
      }
      tick();
    }

    function stopMeter(){
      if(rafId) cancelAnimationFrame(rafId);
      if(ctx) ctx.close();
      rafId=null; ctx=null;
    }

    // ---------------- Call stub ----------------
    async function startCall(){
      try{
        micStream = await navigator.mediaDevices.getUserMedia({audio:true});
        startMeter(micStream);
        log('[mic] granted.');

        if(connectVoice.checked){
          log('[note] voice connect needs backend /api/realtime-session');
        }
        startBtn.disabled=true; hangBtn.disabled=false;
      }catch(err){ log('[error] '+err.message); hangUp(); }
    }
    function hangUp(){
      stopMeter();
      if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; }
      startBtn.disabled=false; hangBtn.disabled=true; log('[call] ended.');
    }
    startBtn.addEventListener('click', startCall);
    hangBtn.addEventListener('click', hangUp);

    // ---------------- Init ----------------
    if(anchor){ applyMouthLayout(); log(`[anchor] restored`); }
    else{ anchor={x:0.51,y:0.31}; saveAnchor(); applyMouthLayout(); log('[anchor] default set'); }
    wLabel.textContent = `${wSlider.value} px`;
  </script>
</body>
</html>
