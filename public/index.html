<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EmotiKnow ‚Äî Emma (D-ID + OpenAI)</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="wrap">
    <h1>EmotiKnow ‚Äî Emma (D-ID + OpenAI)</h1>

    <section class="panel">
      <label>Say or type something to Emma</label>
      <textarea id="userText" rows="3" placeholder="Hi Emma, what can you do?"></textarea>

      <div class="row">
        <button id="speakBtn">Ask Emma</button>
        <button id="micBtn" title="Use browser speech-to-text">üéôÔ∏è Dictate</button>
        <button id="stopMicBtn" disabled>‚ñ† Stop</button>
      </div>

      <div id="status" class="status">Ready.</div>
    </section>

    <section class="stage">
      <video id="emmaVideo" playsinline controls poster="/emma.jpg"></video>
    </section>

    <section class="log">
      <h3>Log</h3>
      <pre id="log"></pre>
    </section>
  </main>

  <script>
    const userText = document.getElementById('userText');
    const speakBtn = document.getElementById('speakBtn');
    const micBtn = document.getElementById('micBtn');
    const stopMicBtn = document.getElementById('stopMicBtn');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const videoEl = document.getElementById('emmaVideo');

    function log(line) {
      logEl.textContent += line + "\\n";
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setStatus(s) { statusEl.textContent = s; }

    async function askEmma() {
      const prompt = userText.value.trim();
      if (!prompt) {
        userText.focus();
        return;
      }

      try {
        setStatus('Thinking (OpenAI)‚Ä¶');
        log('[user] ' + prompt);

        // 1) OpenAI "brain": user -> reply text
        const r1 = await fetch('/api/reply', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ prompt })
        });
        if (!r1.ok) {
          const t = await r1.text();
          log('[error] reply http ' + r1.status + '\\n' + t);
          setStatus('Error from OpenAI.');
          return;
        }
        const { reply } = await r1.json();
        log('[emma] ' + reply);

        // 2) D-ID: reply text -> lip-synced video
        setStatus('Rendering lipsync (D-ID)‚Ä¶');
        const r2 = await fetch('/api/talk', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ text: reply })
        });
        if (!r2.ok) {
          const t = await r2.text();
          log('[error] talk http ' + r2.status + '\\n' + t);
          setStatus('Error from D-ID.');
          return;
        }
        const { videoUrl } = await r2.json();
        log('[video] ' + videoUrl);

        // 3) Play it
        videoEl.src = videoUrl;
        await videoEl.play().catch(()=>{ /* autoplay may be blocked; user can press play */ });
        setStatus('Done. Playing.');
      } catch (err) {
        log('[error] ' + (err?.message || err));
        setStatus('Something went wrong.');
      }
    }

    // Basic browser speech-to-text (Web Speech API) to fill the textbox
    let recognition;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = 'en-US';
      recognition.interimResults = true;
      recognition.onresult = (ev) => {
        let final = '';
        for (const r of ev.results) {
          final += r[0].transcript;
        }
        userText.value = final;
      };
      recognition.onstart = ()=> setStatus('Listening‚Ä¶');
      recognition.onend   = ()=> { setStatus('Ready.'); stopMicBtn.disabled = true; micBtn.disabled = false; }
      micBtn.onclick = () => { recognition.start(); micBtn.disabled = true; stopMicBtn.disabled = false; };
      stopMicBtn.onclick = () => recognition.stop();
    } else {
      micBtn.disabled = true;
      stopMicBtn.disabled = true;
      micBtn.title = 'Speech-to-text not supported in this browser';
    }

    speakBtn.onclick = askEmma;
  </script>
</body>
</html>
