<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emma — Minimal Mouth Test</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; background:#0b0f14; color:#eaf0f7; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
  .wrap { max-width:900px; margin:24px auto; padding:0 16px; }
  textarea, input[type="text"] { width:100%; background:#0a0f14; color:#eaf0f7; border:1px solid #1b2632; border-radius:10px; padding:10px; }
  button { background:#0f62fe; color:#fff; border:0; padding:10px 16px; border-radius:10px; font-weight:600; cursor:pointer; }
  button:disabled { opacity:.6 }
  .row { display:flex; gap:12px; align-items:center; margin:12px 0; flex-wrap:wrap; }
  .label { min-width:120px; }
  input[type="range"] { width:260px; }
  .stage { position:relative; width:640px; height:360px; border-radius:14px; overflow:hidden; background:#000; margin-top:12px; }
  .stage img#bg { width:100%; height:100%; object-fit:cover; display:block; }
  /* mouth sprite */
  #mouth {
    position:absolute; left:260px; top:98px;
    width:300px; height:160px; pointer-events:none;
    transform-origin:center center;
    /* default scale/rotate so sliders visibly affect this element */
    transform:scale(0.50) rotate(-1deg);
  }
</style>
</head>
<body>
<div class="wrap">
  <h2>Emma — Minimal Mouth Test</h2>

  <div class="row">
    <div class="label">Script</div>
    <textarea id="text" rows="3">Hi, I’m Emma. I can talk and move my mouth in sync. How can I help?</textarea>
  </div>
  <div class="row">
    <button id="speak">Speak</button>
    <div>Viseme: <b id="viseme">X</b></div>
  </div>

  <div class="row">
    <div class="label">Image URL</div>
    <input id="imgUrl" type="text" value="/emma.jpg" />
  </div>
  <div class="row">
    <div class="label">Mouth X (<span id="lx">260</span>px)</div>
    <input id="mx" type="range" min="0" max="600" value="260" />
  </div>
  <div class="row">
    <div class="label">Mouth Y (<span id="ly">98</span>px)</div>
    <input id="my" type="range" min="0" max="300" value="98" />
  </div>
  <div class="row">
    <div class="label">Scale (<span id="ls">0.50</span>)</div>
    <input id="ms" type="range" min="0.2" max="2" step="0.01" value="0.50" />
  </div>
  <div class="row">
    <div class="label">Rotate (<span id="lr">-1</span>°)</div>
    <input id="mr" type="range" min="-30" max="30" step="1" value="-1" />
  </div>

  <div class="stage">
    <img id="bg" src="/emma.jpg" alt="Emma" />
    <!-- single-layer mouth for simplest baseline -->
    <img id="mouth" src="/mouth/X.png" alt="mouth" />
  </div>

  <p style="opacity:.8;font-size:13px;margin-top:10px">
    Expected files: <code>/public/emma.jpg</code> and <code>/public/mouth/A.png E.png F.png I.png L.png M.png O.png S.png U.png X.png</code>
  </p>
</div>

<script>
  // ==== DOM ====
  const txt = document.getElementById('text');
  const speakBtn = document.getElementById('speak');
  const visemeEl = document.getElementById('viseme');

  const imgUrl = document.getElementById('imgUrl');
  const bg = document.getElementById('bg');

  const mouth = document.getElementById('mouth');
  const mx = document.getElementById('mx'); const lx = document.getElementById('lx');
  const my = document.getElementById('my'); const ly = document.getElementById('ly');
  const ms = document.getElementById('ms'); const ls = document.getElementById('ls');
  const mr = document.getElementById('mr'); const lr = document.getElementById('lr');

  // ==== Sliders wire-up ====
  function update() {
    mouth.style.left = mx.value + 'px';
    mouth.style.top  = my.value + 'px';
    mouth.style.transform = `scale(${ms.value}) rotate(${mr.value}deg)`;
    lx.textContent = mx.value; ly.textContent = my.value;
    ls.textContent = (+ms.value).toFixed(2); lr.textContent = mr.value;
  }
  [mx, my, ms, mr].forEach(el => el.addEventListener('input', update));
  imgUrl.addEventListener('change', () => { bg.src = imgUrl.value; });
  update();

  // ==== Visemes + simple timeline ====
  const ORDER = ["M","A","E","I","O","U","S","L","F","X"];
  function setViseme(v) { visemeEl.textContent = v; mouth.src = `/mouth/${v}.png`; }
  function makeTimeline(text) {
    const groups = Math.max(8, Math.ceil(text.trim().length / 4));
    return Array.from({length: groups}, (_, i) => ({ t: i*120, v: ORDER[i % ORDER.length] }));
  }

  // ==== Speech (browser SpeechSynthesis) ====
  function speak(text) {
    return new Promise((resolve) => {
      const synth = window.speechSynthesis;
      if (!synth) {
        // no TTS available — just run animation roughly for duration
        const est = Math.max(1500, Math.min(8000, text.length * 50));
        setTimeout(resolve, est);
        return;
      }
      try { synth.cancel(); } catch(e){}
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.0; u.pitch = 1.0; u.onend = resolve; u.onerror = resolve;
      synth.speak(u);
    });
  }

  // ==== Play ====
  speakBtn.addEventListener('click', async () => {
    const marks = makeTimeline(txt.value);
    let i = 0, playing = true;

    // animation loop using setInterval to keep it simple
    setViseme('X');
    const timer = setInterval(() => {
      if (!playing) return;
      const m = marks[i++];
      if (!m) { clearInterval(timer); playing = false; setViseme('X'); return; }
      setViseme(m.v);
    }, 120);

    await speak(txt.value); // runs in parallel
    playing = false;
  });

  // ==== Quick asset sanity check in console (optional) ====
  console.log('Try opening an asset directly:', location.origin + '/mouth/A.png');
</script>
</body>
</html>
