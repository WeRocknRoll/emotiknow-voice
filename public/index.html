<script>
/* --- Auto-crop helper: finds non-transparent bbox of an image --- */
async function autoCropImage(img) {
  const w = img.naturalWidth, h = img.naturalHeight;
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const g = c.getContext('2d');
  g.drawImage(img, 0, 0);
  const { data } = g.getImageData(0, 0, w, h);

  let minX=w, minY=h, maxX=-1, maxY=-1;
  for (let y=0; y<h; y++) {
    for (let x=0; x<w; x++) {
      const a = data[(y*w + x)*4 + 3];
      if (a > 10) { // >10 avoids stray antialias pixels
        if (x < minX) minX = x;
        if (y < minY) minY = y;
        if (x > maxX) maxX = x;
        if (y > maxY) maxY = y;
      }
    }
  }
  if (maxX < 0) {
    // all transparent – fall back to full image
    return { img, sx:0, sy:0, sw:w, sh:h };
  }
  const pad = 2; // tiny padding so edges aren’t clipped
  const sx = Math.max(0, minX - pad);
  const sy = Math.max(0, minY - pad);
  const sw = Math.min(w - sx, (maxX - minX + 1) + pad*2);
  const sh = Math.min(h - sy, (maxY - minY + 1) + pad*2);
  return { img, sx, sy, sw, sh };
}

/* --- Load all mouth frames (lower-case names expected) --- */
const MOUTH_KEYS = ['f','p','g','l','v','i','o','u','say']; // add/remove as you have files
const mouthFrames = {}; // key -> {img,sx,sy,sw,sh}

async function loadMouthFrames() {
  for (const k of MOUTH_KEYS) {
    const url = `/mouth/${k}.png`;
    const img = await new Promise((res, rej) => {
      const el = new Image();
      el.crossOrigin = 'anonymous';
      el.onload = () => res(el);
      el.onerror = rej;
      el.src = url;
    });
    mouthFrames[k] = await autoCropImage(img);
    console.log(`[load] mouth ${k} ✓ (${img.naturalWidth}×${img.naturalHeight})`);
  }
}

/* --- Drawing the mouth: uses crop rect when drawing --- */
// example draw function; adapt to your code paths
function drawMouth(ctx, key, dx, dy, targetWidthPx) {
  const f = mouthFrames[key];
  if (!f) return;

  const scale = targetWidthPx / f.sw;
  const dw = f.sw * scale;
  const dh = f.sh * scale;

  // center on (dx,dy)
  const x = dx - dw/2;
  const y = dy - dh/2;

  ctx.drawImage(f.img, f.sx, f.sy, f.sw, f.sh, x, y, dw, dh);
}

/* --- Example glue (adapt to your UI) --- */
(async () => {
  await loadMouthFrames();
  // … initialize mic/pc etc.
  // during audio frames, pick a key (e.g., 'v' or 'o') and render:
  // drawMouth(ctx, currentKey, mouthX, mouthY, targetWidthSlider.valueAsNumber);
})();
</script>
