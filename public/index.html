<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EmotiKnow Emma</title>
  <style>
    body { background:#111; color:white; font-family:sans-serif; }
    #container { position:relative; display:inline-block; }
    #avatar { display:block; max-width:400px; }
    #mouth {
      position:absolute;
      top:0;
      left:0;
      transform-origin:center center;
      pointer-events:none;
    }
    .controls { margin-top:20px; }
    textarea { width:300px; height:80px; }
  </style>
</head>
<body>
  <h1>EmotiKnow Emma</h1>

  <div id="container">
    <img id="avatar" src="emma.jpg" />
    <img id="mouth" src="/mouth/X.png" />
  </div>

  <div class="controls">
    <p>Script</p>
    <textarea id="text">Hi, Iâ€™m Emma. I can talk and move my mouth in sync. How can I help?</textarea><br>
    <button id="speak">Speak</button> Viseme: <span id="viseme">X</span>
    <br><br>
    Mouth X: <input type="range" id="mouthX" min="0" max="400" value="165"><br>
    Mouth Y: <input type="range" id="mouthY" min="0" max="400" value="100"><br>
    Scale: <input type="range" id="mouthScale" min="0.2" max="2" step="0.01" value="0.5"><br>
    Rotate: <input type="range" id="mouthRotate" min="-30" max="30" step="1" value="0"><br>
  </div>

<script>
const VISEMES = ["X","A","E","I","O","U","M","F","L","S"];
const MOUTH_BASE = "/mouth/";

const mouthImg = document.getElementById("mouth");
const visemeEl = document.getElementById("viseme");

const sliders = {
  x: document.getElementById("mouthX"),
  y: document.getElementById("mouthY"),
  scale: document.getElementById("mouthScale"),
  rot: document.getElementById("mouthRotate")
};

function updateTransform() {
  const x = sliders.x.value;
  const y = sliders.y.value;
  const s = sliders.scale.value;
  const r = sliders.rot.value;
  mouthImg.style.left = x+"px";
  mouthImg.style.top = y+"px";
  mouthImg.style.transform = `scale(${s}) rotate(${r}deg)`;
}

// attach slider updates
Object.values(sliders).forEach(sl => sl.addEventListener("input", updateTransform));
updateTransform();

function setViseme(v) {
  if (!VISEMES.includes(v)) v = "X";
  mouthImg.src = `${MOUTH_BASE}${v}.png`;
  visemeEl.textContent = v;
}

// Fake timeline generator
function fakeTimeline(text) {
  const seq = ["M","A","E","I","O","U","S","L","F","X"];
  const groups = Math.max(8, Math.min(60, text.length / 2));
  return Array.from({length: groups}, (_,i)=>({t:i*120, v:seq[i%seq.length]}));
}

// Animate
function animate(marks, start) {
  const step = () => {
    const elapsed = performance.now() - start;
    let v="X";
    for (let i=0;i<marks.length;i++) {
      if (elapsed >= marks[i].t) v=marks[i].v; else break;
    }
    setViseme(v);
    if (elapsed < marks[marks.length-1].t) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

document.getElementById("speak").onclick = async () => {
  const txt = document.getElementById("text").value.trim();
  const marks = fakeTimeline(txt);
  const u = new SpeechSynthesisUtterance(txt);
  u.rate=1;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
  animate(marks, performance.now());
};
</script>
</body>
</html>
