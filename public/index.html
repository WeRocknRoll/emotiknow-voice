<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EmotiKnow — Emma (Voice Companion)</title>
  <style>
    :root{--bg:#0f1117;--panel:#151823;--ink:#e6e8ef;--muted:#9aa3b2;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:flex;gap:16px;padding:16px;overflow:hidden}
    .card{background:var(--panel);border-radius:14px;box-shadow:0 0 0 1px #0007,0 8px 30px #0008;padding:16px;display:flex;flex-direction:column;gap:12px}
    .left{flex:1;min-width:640px} .right{width:420px;min-width:320px}
    .title{display:flex;align-items:center;gap:12px;font-weight:700}
    .badge{background:#263043;color:#9cc3ff;border-radius:999px;padding:4px 10px;font-size:12px}
    .fit-toggle{margin-left:auto}
    .stage{position:relative;background:#0b0d13;border-radius:10px;overflow:hidden;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center}
    #portrait{max-width:100%;max-height:100%;object-fit:contain;user-select:none;pointer-events:none}
    #mouth{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:260px;filter:drop-shadow(0 0 12px #0006);user-select:none;pointer-events:none}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row .label{min-width:90px;color:var(--muted)} input[type=range]{width:240px}
    .btn{background:#1f2532;color:var(--ink);border:1px solid #0007;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#242c3b} .btn.ghost{background:transparent;border:1px solid #2b3342}
    pre{margin:0;font:12px/1.4 ui-monospace,SFMono-Regular,Consolas,Monaco,monospace;color:#c6d3f0;white-space:pre-wrap}
    .tip{color:var(--muted)}
  </style>
</head>
<body>
  <section class="card left">
    <div class="title">
      EmotiKnow — Emma (Voice Companion)
      <span class="badge" id="status">idle</span>
      <button id="fitBtn" class="btn ghost fit-toggle">Fit: contain</button>
    </div>

    <div id="stage" class="stage">
      <img id="portrait" alt="portrait" />
      <img id="mouth" alt="mouth" />
    </div>

    <div class="row">
      <span class="label">Target width</span>
      <input id="widthSlider" type="range" min="80" max="480" value="260" />
      <span id="widthVal">260 px</span>

      <span class="label" style="margin-left:18px">Scale</span>
      <input id="scaleSlider" type="range" min="50" max="220" value="100" />
      <span id="scaleVal">100 %</span>

      <button id="startBtn" class="btn">Start</button>
      <button id="stopBtn"  class="btn ghost">Hang Up</button>
    </div>

    <div class="tip">Tip: Click Emma’s mouth to re-anchor the lips; use the sliders to size &amp; scale. The anchor is saved per browser.</div>
  </section>

  <section class="card right">
    <div class="title">Diagnostics</div>
    <pre id="log"></pre>
  </section>

<script>
/* -------- logger -------- */
const logEl=document.getElementById('log');
function log(...a){const s=a.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' ');logEl.textContent+=s+'\n';logEl.scrollTop=logEl.scrollHeight}

/* -------- elements -------- */
const stage=document.getElementById('stage');
const portrait=document.getElementById('portrait');
const mouth=document.getElementById('mouth');
const widthSl=document.getElementById('widthSlider');
const scaleSl=document.getElementById('scaleSlider');
const widthVal=document.getElementById('widthVal');
const scaleVal=document.getElementById('scaleVal');
const fitBtn=document.getElementById('fitBtn');
const statusEl=document.getElementById('status');

/* -------- saved anchor -------- */
const anchorKey='emma-mouth-anchor';
let anchor=JSON.parse(localStorage.getItem(anchorKey)||'{"x":0.5,"y":0.62}');
function saveAnchor(){localStorage.setItem(anchorKey,JSON.stringify(anchor))}
stage.addEventListener('click',e=>{
  const r=stage.getBoundingClientRect();
  anchor.x=(e.clientX-r.left)/r.width;
  anchor.y=(e.clientY-r.top)/r.height;
  saveAnchor(); positionMouth();
  log(`[anchor] saved x=${anchor.x.toFixed(3)}, y=${anchor.y.toFixed(3)}`);
});

/* -------- portrait (your lowercase m.png) -------- */
let fitMode='contain';
fitBtn.onclick=()=>{fitMode=fitMode==='contain'?'cover':'contain';portrait.style.objectFit=fitMode;fitBtn.textContent=`Fit: ${fitMode}`};

(function loadPortrait(){
  const src='/m.png';
  portrait.onload=()=>{
    const nw=portrait.naturalWidth||1920, nh=portrait.naturalHeight||1200;
    stage.style.aspectRatio=`${nw} / ${nh}`;
    portrait.style.objectFit=fitMode;
    log(`[portrait] loaded ${src} natural ${nw}×${nh}`);
    positionMouth();
  };
  portrait.onerror=()=>log(`[portrait] ERROR loading ${src} — check path`);
  portrait.src=src+'?v='+Date.now();
})();

/* -------- frames (all lowercase) -------- */
const FRAMES=['f','p','g','i','l','o','u','v','say'];
const mouthImgs={}; let loaded=0;
FRAMES.forEach(n=>{
  const img=new Image();
  img.onload=()=>{mouthImgs[n]=img;loaded++; if(loaded===FRAMES.length) log(`[frames] loaded ${loaded}/${FRAMES.length}`)};
  img.onerror=()=>log(`[frames] ERROR /mouth/${n}.png`);
  img.src=`/mouth/${n}.png?v=${Date.now()}`;
});

/* -------- sliders -------- */
function sync(){widthVal.textContent=`${widthSl.value} px`;scaleVal.textContent=`${scaleSl.value} %`}
widthSl.oninput=()=>{sync();positionMouth()}; scaleSl.oninput=()=>{sync();positionMouth()}; sync();

/* -------- position mouth -------- */
function positionMouth(){
  if(!portrait.naturalWidth) return;
  const r=stage.getBoundingClientRect();
  const scale=Number(scaleSl.value)/100;
  mouth.style.width=`${Number(widthSl.value)}px`;
  mouth.style.left =`${anchor.x * r.width}px`;
  mouth.style.top  =`${anchor.y * r.height}px`;
  mouth.style.transform=`translate(-50%,-50%) scale(${scale})`;
}

/* -------- quick frame cycler (visual check) -------- */
let idx=0, timer=null;
function startCycle(){ if(timer) return; timer=setInterval(()=>{const n=FRAMES[idx%FRAMES.length]; if(mouthImgs[n]) mouth.src=mouthImgs[n].src; idx++},200) }
function stopCycle(){ clearInterval(timer); timer=null }

document.getElementById('startBtn').onclick=()=>{statusEl.textContent='live';statusEl.style.background='#1f5e2e';startCycle()};
document.getElementById('stopBtn').onclick =()=>{statusEl.textContent='idle';statusEl.style.background='';stopCycle()};
</script>
</body>
</html>
